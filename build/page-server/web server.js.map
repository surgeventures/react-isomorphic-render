{"version":3,"sources":["../../source/page-server/web server.js"],"names":["start_webpage_rendering_server","settings","options","assets","localize","application","authentication","render","loading","stats","html","initialize","web","use","ctx","next","process","env","NODE_ENV","print_error","response_status","response_body","status","body","type","console","log","stack","error","message","middleware","url","request","originalUrl","replace","total_timer","parameters","undefined","req","cookies","content","redirect","route","time","afterwards","path","querystring","total"],"mappings":"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","file":"web server.js","sourcesContent":["import koa from 'koa'\n\nimport render_page from './render'\nimport { get_preferred_locales } from './locale'\nimport render_stack_trace from './html stack trace'\n\nimport timer from '../timer'\n\nexport default function start_webpage_rendering_server(settings, options)\n{\n\tconst\n\t{\n\t\tassets,\n\t\tlocalize,\n\t\tapplication,\n\t\tauthentication,\n\t\trender,\n\t\tloading,\n\t\tstats,\n\t\thtml,\n\t\tinitialize\n\t}\n\t= options\n\n\tconst web = new koa()\n\n\t// Handles errors\n\tweb.use(async (ctx, next) =>\n\t{\n\t\ttry\n\t\t{\n\t\t\tawait next()\n\t\t}\n\t\tcatch (error)\n\t\t{\n\t\t\t// if the error is caught here it means that `catch`\n\t\t\t// (error handler parameter) didn't resolve it\n\t\t\t// (or threw it)\n\n\t\t\t// show error stack trace in development mode for easier debugging\n\t\t\tif (process.env.NODE_ENV !== 'production')\n\t\t\t{\n\t\t\t\ttry\n\t\t\t\t{\n\t\t\t\t\tconst { response_status, response_body } = render_stack_trace(error, options.print_error)\n\n\t\t\t\t\tif (response_body)\n\t\t\t\t\t{\n\t\t\t\t\t\tctx.status = response_status || 500\n\t\t\t\t\t\tctx.body = response_body\n\t\t\t\t\t\tctx.type = 'html'\n\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcatch (error)\n\t\t\t\t{\n\t\t\t\t\tconsole.log('(couldn\\'t render error stack trace)')\n\t\t\t\t\tconsole.log(error.stack || error)\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// log the error\n\t\t\tconsole.log('[react-isomorphic-render] Webpage rendering server error')\n\n\t\t\tif (options.log)\n\t\t\t{\n\t\t\t\toptions.log.error(error)\n\t\t\t}\n\n\t\t\tctx.status = typeof error.status === 'number' ? error.status : 500\n\t\t\tctx.message = error.message || 'Internal error'\n\t\t}\n\t})\n\n\t// Custom Koa middleware extension point\n\t// (if someone ever needs this)\n\tif (options.middleware)\n\t{\n\t\tfor (let middleware of options.middleware)\n\t\t{\n\t\t\tweb.use(middleware)\n\t\t}\n\t}\n\n\t// Isomorphic rendering\n\tweb.use(async (ctx) =>\n\t{\n\t\t// Trims a question mark in the end (just in case)\n\t\tconst url = ctx.request.originalUrl.replace(/\\?$/, '')\n\n\t\tconst total_timer = timer()\n\n\t\tconst { status, content, redirect, route, time, afterwards } = await render_page(settings,\n\t\t{\n\t\t\tapplication,\n\t\t\tassets,\n\t\t\tinitialize,\n\t\t\tlocalize: localize ? parameters => localize(parameters, get_preferred_locales(ctx)) : undefined,\n\t\t\trender,\n\t\t\tloading,\n\t\t\thtml,\n\t\t\tauthentication,\n\n\t\t\t// The original HTTP request can be required\n\t\t\t// for inspecting cookies in `preload` function\n\t\t\trequest: ctx.req,\n\n\t\t\t// Cookies for protected cookie value retrieval\n\t\t\tcookies: ctx.cookies\n\t\t})\n\n\t\t// Can add `Set-Cookie` headers, for example.\n\t\tif (afterwards)\n\t\t{\n\t\t\tafterwards(ctx)\n\t\t}\n\n\t\tif (redirect)\n\t\t{\n\t\t\treturn ctx.redirect(redirect)\n\t\t}\n\n\t\tif (status)\n\t\t{\n\t\t\tctx.status = status\n\t\t}\n\n\t\tctx.body = content\n\n\t\tif (stats)\n\t\t{\n\t\t\tstats\n\t\t\t({\n\t\t\t\turl: ctx.path + (ctx.querystring ? `?${ctx.querystring}` : ''),\n\t\t\t\troute,\n\t\t\t\ttime:\n\t\t\t\t{\n\t\t\t\t\t...time,\n\t\t\t\t\ttotal: total_timer()\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t})\n\n\treturn web\n}"]}