{"version":3,"sources":["../../source/page-server/render.js"],"names":["settings","initialize","localize","assets","application","request","render","loading","html","cookies","beforeRender","routes","wrapper","authentication","error_handler","error","render_page","protected_cookie_value","protectedCookie","get","history","get_history","initialize_timer","initialize_result","extension_javascript","afterwards","parameters","normalize_result","_normalize_result","result","url","location","getCurrentLocation","path","pathname","initialize_time","locale","messages","messagesJSON","then","disable_server_side_rendering","before_render","create_page_element","child_element","props","createElement","render_webpage","content","normalize_markup","renderToString","head","body_start","bodyStart","body_end","bodyEnd","entries","Error","locale_messages_json","time","_redirect","redirect","error_handler_parameters","to","server","store","dispatch","redirecting_dispatch","getState","anything","Array","isArray","map","join","event","type","basename","options"],"mappings":"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","file":"render.js","sourcesContent":["// produces wrong line numbers:\n// import 'source-map-support/register'\n\nimport React from 'react'\nimport ReactDOM from 'react-dom/server'\n\n// https://github.com/ReactTraining/react-router/issues/4023\n// Also adds `useBasename` and `useQueries`\nimport createHistory from 'react-router/lib/createMemoryHistory'\n\nimport Html from './html'\nimport normalize_common_settings from '../redux/normalize'\nimport timer from '../timer'\nimport create_history from '../history'\nimport { location_url, parse_location } from '../location'\n\nimport redux_render, { initialize as redux_initialize } from '../redux/server/server'\nimport { render_on_server as react_router_render } from '../react-router/render'\n\nimport { Preload } from '../redux/actions'\n\n// isomorphic (universal) rendering (middleware).\n// will be used in web_application.use(...)\nexport default async function(settings, { initialize, localize, assets, application, request, render, loading, html = {}, cookies, beforeRender })\n{\n\tsettings = normalize_common_settings(settings)\n\n\tconst\n\t{\n\t\troutes,\n\t\twrapper,\n\t\tauthentication\n\t}\n\t= settings\n\n\tconst error_handler = settings.error\n\n\t// If Redux is being used, then render for Redux.\n\t// Else render for pure React.\n\tconst render_page = redux_render\n\n\t// Read protected cookie value (if configured)\n\tlet protected_cookie_value\n\tif (authentication && authentication.protectedCookie)\n\t{\n\t\tprotected_cookie_value = cookies.get(authentication.protectedCookie)\n\t}\n\n\t// `history` is created after the `store`.\n\t// At the same time, `store` needs the `history` later during navigation.\n\t// And `history` might need store for things like `react-router-redux`.\n\t// Hence the getter instead of a simple variable\n\tlet history\n\tconst get_history = () => history\n\n\tconst initialize_timer = timer()\n\n\t// These `parameters` are used for `assets`, `html` modifiers\n\t// and also for `localize()` call.\n\tconst initialize_result = await redux_initialize(settings,\n\t{\n\t\tprotected_cookie_value,\n\t\tapplication,\n\t\trequest,\n\t\tcookies,\n\t\tinitialize,\n\t\tget_history\n\t})\n\t\n\tconst { extension_javascript, afterwards, ...parameters } = initialize_result\t\n\n\tconst normalize_result = result => _normalize_result(result, afterwards, settings)\n\n\t// Create `history` (`true` indicates server-side usage).\n\t// Koa `request.url` is not really a URL,\n\t// it's a URL without the `origin` (scheme, host, port).\n\thistory = create_history(createHistory, request.url, settings.history, parameters, true)\n\n\tconst location = history.getCurrentLocation()\n\tconst path     = location.pathname\n\n\t// The above code (server-side `initialize()` method call) is not included\n\t// in this `try/catch` block because:\n\t//\n\t//  * `parameters` are used inside `.error()`\n\t//\n\t//  * even if an error was caught inside `initialize()`\n\t//    and a redirection was performed, say, to an `/error` page\n\t//    then it would fail again because `initialize()` would get called again,\n\t//    so wrapping `initialize()` with `try/catch` wouldn't help anyway.\n\t//\n\ttry\n\t{\n\t\tconst initialize_time = initialize_timer()\n\n\t\t// Internationalization\n\n\t\tlet locale\n\t\tlet messages\n\t\tlet messagesJSON\n\n\t\tif (localize)\n\t\t{\n\t\t\t// `localize()` should normally be a synchronous function.\n\t\t\t// It could be asynchronous though for cases when it's taking\n\t\t\t// messages not from a JSON file but rather from an\n\t\t\t// \"admin\" user editable database.\n\t\t\t// If the rountrip time (ping) from the rendering service\n\t\t\t// to the database is small enough then it theoretically\n\t\t\t// won't introduce any major page rendering latency\n\t\t\t// (the database will surely cache such a hot query).\n\t\t\t// On the other hand, if a developer fights for each millisecond\n\t\t\t// then `localize()` should just return `messages` from memory.\n\n\t\t\tlet result = localize(parameters)\n\n\t\t\t// If `localize()` returned a `Promise` then wait for it\n\t\t\tif (typeof result.then === 'function')\n\t\t\t{\n\t\t\t\tresult = await result\n\t\t\t}\n\n\t\t\tlocale   = result.locale\n\t\t\tmessages = result.messages\n\n\t\t\t// A tiny optimization to avoid calculating\n\t\t\t// `JSON.stringify(messages)` for each rendered page:\n\t\t\t// `localize()` can return a cached `messagesJSON` string\n\t\t\t// instead of `messages` JSON object\n\t\t\t// to further reduce internationalization-induced latency\n\t\t\t// by an extra millisecond or so (benchmark if interested)\n\t\t\t// by not stringifying `messages` JSON object for each page rendered.\n\t\t\tmessagesJSON = result.messagesJSON || JSON.stringify(messages)\n\t\t}\n\n\t\t// Render the web page\n\t\tconst result = await render_page\n\t\t({\n\t\t\t...parameters,\n\t\t\tdisable_server_side_rendering: render === false,\n\t\t\thistory,\n\t\t\troutes,\n\t\t\tbefore_render: beforeRender,\n\n\t\t\tcreate_page_element: (child_element, props) => \n\t\t\t{\n\t\t\t\tif (localize)\n\t\t\t\t{\n\t\t\t\t\tprops.locale   = locale\n\t\t\t\t\tprops.messages = messages\n\t\t\t\t}\n\n\t\t\t\treturn React.createElement(wrapper, props, child_element)\n\t\t\t},\n\n\t\t\trender_webpage(content)\n\t\t\t{\n\t\t\t\t// Render page content\n\t\t\t\tcontent = render === false ? normalize_markup(loading) : (content && ReactDOM.renderToString(content))\n\n\t\t\t\t// `html` modifiers\n\n\t\t\t\tlet { head } = html\n\t\t\t\t// camelCase support for those who prefer it\n\t\t\t\tlet body_start = html.body_start || html.bodyStart\n\t\t\t\tlet body_end   = html.body_end   || html.bodyEnd\n\n\t\t\t\t// Normalize `html` parameters\n\t\t\t\thead       = normalize_markup(typeof head       === 'function' ? head      (path, parameters) : head)\n\t\t\t\tbody_start = normalize_markup(typeof body_start === 'function' ? body_start(path, parameters) : body_start)\n\t\t\t\tbody_end   = normalize_markup(typeof body_end   === 'function' ? body_end  (path, parameters) : body_end)\n\n\t\t\t\t// Normalize assets\n\t\t\t\tassets = typeof assets === 'function' ? assets(path, parameters) : assets\n\n\t\t\t\t// Sanity check\n\t\t\t\tif (!assets.entries)\n\t\t\t\t{\n\t\t\t\t\tthrow new Error(`\"assets.entries\" array parameter is required as of version 10.1.0. E.g. \"{ ... entries: ['main'] ... }\"`)\n\t\t\t\t}\n\n\t\t\t\t// Render the HTML\n\t\t\t\treturn Html\n\t\t\t\t({\n\t\t\t\t\t...parameters,\n\t\t\t\t\textension_javascript: typeof extension_javascript === 'function' ? extension_javascript() : extension_javascript,\n\t\t\t\t\tassets,\n\t\t\t\t\tlocale,\n\t\t\t\t\tlocale_messages_json: messagesJSON,\n\t\t\t\t\thead,\n\t\t\t\t\tbody_start,\n\t\t\t\t\tbody_end,\n\t\t\t\t\tprotected_cookie_value,\n\t\t\t\t\tcontent\n\t\t\t\t})\n\t\t\t}\n\t\t})\n\n\t\tif (result.time)\n\t\t{\n\t\t\tresult.time.initialize = initialize_time\n\t\t}\n\n\t\treturn normalize_result(result)\n\t}\n\tcatch (error)\n\t{\n\t\t// Redirection is sometimes done via an Error on server side.\n\t\t// (e.g. it can happen in `react-router`'s `onEnter()` during `match()`)\n\t\tif (error._redirect)\n\t\t{\n\t\t\treturn normalize_result({ redirect: error._redirect })\n\t\t}\n\n\t\tif (error_handler)\n\t\t{\n\t\t\tconst result = {}\n\n\t\t\tconst error_handler_parameters =\n\t\t\t{\n\t\t\t\tpath,\n\t\t\t\turl      : location_url(location),\n\t\t\t\tredirect : to => result.redirect = parse_location(to),\n\t\t\t\tserver   : true\n\t\t\t}\n\n\t\t\t// Special case for Redux\n\t\t\tif (parameters.store)\n\t\t\t{\n\t\t\t\terror_handler_parameters.dispatch = redirecting_dispatch(parameters.store.dispatch, error_handler_parameters.redirect)\n\t\t\t\terror_handler_parameters.getState = parameters.store.getState\n\t\t\t}\n\n\t\t\terror_handler(error, error_handler_parameters)\n\t\t\n\t\t\t// Either redirects or throws the error\n\t\t\tif (result.redirect)\n\t\t\t{\n\t\t\t\treturn normalize_result(result)\n\t\t\t}\n\t\t}\n\n\t\tthrow error\n\t}\n}\n\n// Converts React.Elements to Strings\nfunction normalize_markup(anything)\n{\n\tif (!anything)\n\t{\n\t\treturn ''\n\t}\n\n\tif (typeof anything === 'function')\n\t{\n\t\treturn anything\n\t}\n\n\tif (typeof anything === 'string')\n\t{\n\t\treturn anything\n\t}\n\n\tif (Array.isArray(anything))\n\t{\n\t\treturn anything.map(normalize_markup).join('')\n\t}\n\n\treturn ReactDOM.renderToString(anything)\n}\n\n// A special flavour of `dispatch` which `throw`s for redirects on the server side.\nfunction redirecting_dispatch(dispatch, redirect)\n{\n\treturn (event) =>\n\t{\n\t\tswitch (event.type)\n\t\t{\n\t\t\t// In case of navigation from @preload()\n\t\t\tcase Preload:\n\t\t\t\t// `throw`s a special `Error` on server side\n\t\t\t\treturn redirect(event.location)\n\t\t\n\t\t\tdefault:\n\t\t\t\t// Proceed with the original\n\t\t\t\treturn dispatch(event)\n\t\t}\n\t}\n}\n\nfunction _normalize_result(result, afterwards, settings)\n{\n\t// Stringify `redirect` location\n\tif (result.redirect)\n\t{\n\t\t// Prepend `basename` to relative URLs for server-side redirect.\n\t\tresult.redirect = location_url(result.redirect, { basename: settings.history.options.basename })\n\t}\n\n\t// Add `afterwards`\n\tresult.afterwards = afterwards\n\n\treturn result\n}"]}